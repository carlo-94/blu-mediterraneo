/* ===================== I18N dictionary (IT/EN/ES) ===================== */
  const I18N = {
    "nav.home": { it:"Home", en:"Home", es:"Inicio" },
    "nav.services": { it:"Servizi & Regole", en:"Services & Rules", es:"Servicios y Normas" },
    "nav.gallery": { it:"Galleria", en:"Gallery", es:"GalerÃ­a" },
    "nav.reviews": { it:"Recensioni", en:"Reviews", es:"ReseÃ±as" },
    "nav.itineraries": { it:"Itinerari", en:"Itineraries", es:"Itinerarios" },
    "cta.contact": { it:"Contatti", en:"Contact", es:"Contacto" },
    "hero.title": { it:"Casa vacanze Blu Mediterraneo", en:"Blu Mediterraneo Holiday Home", es:"Casa vacacional Blu Mediterraneo" },
    "hero.subtitle": { it:"Il tuo rifugio sul mare", en:"Your seaside retreat", es:"Tu refugio junto al mar" },
    "hero.cta1": { it:"Scopri i servizi", en:"Explore services", es:"Descubre los servicios" },
    "hero.cta2": { it:"Guarda la galleria", en:"View gallery", es:"Ver galerÃ­a" },
    "about.title": { it:"La struttura", en:"About the property", es:"La propiedad" },
    "about.body": { it:"Un appartamento situato nel cuore di Salerno, perfettamente posizionato per godere della magia delle Luci d'Artista e della vicinanza al mare. La casa Ã¨ luminosa e ben curata, con interni moderni e accoglienti.La zona offre tutto il necessario: ristoranti, negozi, mezzi pubblici, e attrazioni culturali come il centro storico, il Duomo, il teatro Verdi, il lungomare e la villa comunale.Un rifugio silenzioso nel cuore di Salerno.", en:"An apartment located in the heart of Salerno, perfectly positioned to enjoy the magic of the Luci d'Artista light installations and the proximity to the sea. The home is bright and well maintained, with modern and welcoming interiors.The area offers everything you need: restaurants, shops, public transport, and cultural attractions such as the historic centre, the Cathedral, the Verdi Theatre, the seafront promenade and the municipal park.A quiet retreat in the heart of Salerno.", es:"Un apartamento situado en el corazÃ³n de Salerno, perfectamente ubicado para disfrutar de la magia de las Luci d'Artista y de la cercanÃ­a al mar. La casa es luminosa y bien cuidada, con interiores modernos y acogedores.La zona ofrece todo lo necesario: restaurantes, tiendas, transporte pÃºblico y atracciones culturales como el casco histÃ³rico, la catedral, el Teatro Verdi, el paseo marÃ­timo y el parque municipal.Un refugio tranquilo en el corazÃ³n de Salerno." },
    "services.mainTitle": { it:"Servizi principali", en:"Main amenities", es:"Servicios principales" },
    "services.more": { it:"Servizi +", en:"Services +", es:"Servicios +" },
    "services.cap.label": { it:"1â€“3 ospiti", en:"1â€“3 guests", es:"1â€“3 huÃ©spedes" },
    "services.cap.value": { it:"Camera matrimoniale + divano letto", en:"Double bedroom + sofa bed", es:"Dormitorio doble + sofÃ¡ cama" },
    "services.wifi.label": { it:"Wi-Fi", en:"Wi-Fi", es:"Wi-Fi" },
    "services.wifi.value": { it:"Perfetto per lavoro da remoto", en:"Great for remote work", es:"Ideal para teletrabajo" },
    "services.ac.label": { it:"Aria condizionata", en:"Air conditioning", es:"Aire acondicionado" },
    "services.ac.value": { it:"Climatizzazione estate/inverno", en:"Heating & cooling all year", es:"CalefacciÃ³n y refrigeraciÃ³n todo el aÃ±o" },
    "services.kitchen.label": { it:"Cucina", en:"Kitchen", es:"Cocina" },
    "services.kitchen.value": { it:"Fornetto, piano cottura, frigorifero", en:"toaster oven, cooktop, refrigerator", es:"minihorno elÃ©ctrico, encimera y frigorÃ­fico" },
    "services.laundry.label": { it:"Lavatrice", en:"Washing machine", es:"Lavadora" },
    "services.laundry.value": { it:"Set cortesia e stendino", en:"Detergent starter set & drying rack", es:"Kit de detergente y tendedero" },
    "services.beach.label": { it:"Vicino al mare", en:"Near the beach", es:"Cerca de la playa" },
    "services.beach.value": { it:"Spiaggia raggiungibile a piedi", en:"Beach reachable on foot", es:"Playa accesible a pie" },
    "extras.title": { it:"Servizi extra", en:"Extra services", es:"Servicios extra" },
    "label.priceOnRequest": { it:"Prezzo su richiesta", en:"Price on request", es:"Precio bajo consulta" },
    "label.free": { it:"Gratuito", en:"Free", es:"Gratuito" },
    "extras.bagage.title": { it:"Deposito bagagli", en:"Luggage storage", es:"Consigna de equipaje" },
    "extras.bagage.desc": { it:"PossibilitÃ  di lasciare i bagagli in deposito dopo il check-out entro la giornata.", en:"Luggage storage available after check-out until the end of the day.", es:"Posibilidad de dejar el equipaje en consigna despuÃ©s del check-out hasta el final del dÃ­a."},
    "extras.late.title": { it:"Late check-out", en:"Late check-out", es:"Check-out tardÃ­o" },
    "extras.late.desc": { it:"Dopo le 10:00, in base alla disponibilitÃ .", en:"After 10:00 a.m., subject to availability.", es:"DespuÃ©s de las 10:00, segÃºn disponibilidad." },
    "rules.title": { it:"Regole della casa", en:"House rules", es:"Normas de la casa" },
    "rules.more": { it:"Regole +", en:"Rules +", es:"Normas +" },
    "rules.times": { it:"Check-in 16:00â€“22:00 Â· Check-out entro le 10:00", en:"Check-in 4:00â€“10:00 PM Â· Check-out by 10:00 AM", es:"Check-in 16:00â€“22:00 Â· Check-out hasta las 10:00" },
    "rules.idlaw": { it:"Documento dâ€™identitÃ  allâ€™arrivo (obbligo di legge)", en:"ID required at check-in (by law)", es:"Documento de identidad requerido al check-in (por ley)" },
    "rules.nosmoke": { it:"Appartamento per non fumatori", en:"Non-smoking apartment", es:"Alojamiento para no fumadores" },
    "rules.noparties": { it:"No feste/eventi non autorizzati", en:"No parties/events without approval", es:"No fiestas/eventos sin autorizaciÃ³n" },
    "rules.pets": { it:"Animali solo su richiesta e previa conferma", en:"Pets on request and prior approval only", es:"Mascotas solo bajo peticiÃ³n y previa confirmaciÃ³n" },
    "rules.quiet": { it:"Silenzio dopo le 22:00 (rispetto del vicinato)", en:"Quiet hours after 10 PM (respect neighbors)", es:"Silencio despuÃ©s de las 22:00 (respeta al vecindario)" },
    "gallery.title": { it:"Galleria", en:"Gallery", es:"GalerÃ­a" },
    "gallery.tab.day": { it:"Zona giorno", en:"Living area", es:"Zona de dÃ­a" },
    "gallery.tab.night": { it:"Zona notte", en:"Bedroom", es:"Dormitorio" },
    "gallery.tab.bath": { it:"Bagno", en:"Bathroom", es:"BaÃ±o" },
    "gallery.tab.balcony": { it:"Balcone / Esterni", en:"Balcony / Outside", es:"BalcÃ³n / Exteriores" },
    "reviews.title": { it:"Recensioni", en:"Reviews", es:"ReseÃ±as" },
    "reviews.more": { it:"Recensioni +", en:"Reviews +", es:"ReseÃ±as +" },
    "reviews.r1": { it:"â€œA due passi dal centro storico e dal lungomare: posizione perfetta per muoversi a piedi o con i mezzi. La zona Ã¨ molto silenziosa, il letto Ã¨ comodissimo. Lâ€™appartamento Ã¨ ampio, nuovissimo, con impianti perfettamente funzionanti; cucina e bagno sono attrezzati con tutti i comfort. Molto luminoso, dispone di due balconi, uno dei quali con una splendida vista sulla Chiesa dellâ€™Annunziata. Abbiamo trovato questa posizione ideale anche per imbarcarsi facilmente sui traghetti verso la Costiera Amalfitana. Giovanni ci ha accolti di persona, fornendoci utili indicazioni su ristoranti e luoghi da visitare, ed Ã¨ stato molto flessibile con lâ€™orario di check-in. Inoltre ci ha gentilmente permesso di lasciare i bagagli ben oltre lâ€™orario di check-out. Torneremo sicuramente in questo appartamento.â€", en:"â€œJust a short walk from the historic center and the seafront, in a perfect location for getting around on foot or by public transport. The area is very quiet and the bed is extremely comfortable. The apartment is spacious, brand new, with perfectly functioning systems; the kitchen and bathroom are fully equipped with all amenities. It is very bright and has two balconies, one of which offers a beautiful view of the Church of the Annunziata. We also found it very convenient as a base to take the ferry and visit the Amalfi Coast. Giovanni welcomed us in person, gave us helpful tips on restaurants and places to visit, and was very flexible with check-in. He also kindly allowed us to leave our luggage well beyond the check-out time. We will definitely return to this apartment.â€", es:"â€œA pocos pasos del centro histÃ³rico y del paseo marÃ­timo, en una ubicaciÃ³n perfecta para moverse a pie o en transporte pÃºblico. La zona es muy tranquila y la cama es muy cÃ³moda. El apartamento es amplio, nuevo, con instalaciones que funcionan perfectamente; la cocina y el baÃ±o estÃ¡n completamente equipados con todas las comodidades. Es muy luminoso y tiene dos balcones, uno de ellos con una hermosa vista de la iglesia de la Annunziata. TambiÃ©n nos pareciÃ³ una base ideal para tomar el ferry y visitar la Costa Amalfitana. Giovanni nos recibiÃ³ en persona, nos dio recomendaciones muy Ãºtiles sobre restaurantes y lugares que visitar, y fue muy flexible con la hora de check-in. AdemÃ¡s, nos permitiÃ³ dejar el equipaje mucho despuÃ©s de la hora de check-out. Sin duda volveremos a este apartamento.â€" },
    "reviews.r2": { it:"â€œSplendido appartamento, curato in ogni dettaglio. Molto pulito, arredato in modo ottimale e dotato di tutti i servizi essenziali e non solo. Abbiamo apprezzato lâ€™attenzione del proprietario e di suo figlio Carlo, che offrono anche un servizio navetta extra, facoltativo e a pagamento: persona molto discreta, disponibile e professionale. Una vera combinazione di comfort e ospitalitÃ . Lo consigliamo vivamente.â€", en:"â€œBeautiful apartment, cared for in every detail. Very clean, functionally furnished and equipped with all essential amenities and more. We really appreciated the attention of the owner and his son Carlo. There is also an extra shuttle service available, optional and for a fee, with a very discreet and helpful driver. A perfect combination of comfort and hospitality. We highly recommend it.â€", es:"â€œPrecioso apartamento, cuidado en cada detalle. Muy limpio, amueblado de forma funcional y equipado con todas las comodidades esenciales y mÃ¡s. Apreciamos mucho la atenciÃ³n del propietario y de su hijo Carlo. TambiÃ©n hay disponible un servicio de traslado extra, opcional y de pago, con un conductor muy discreto y servicial. Una combinaciÃ³n perfecta de comodidad y hospitalidad. Lo recomendamos altamente.â€" },
    "reviews.r3": { it:"â€œCi siamo trovati subito benissimo nellâ€™appartamento: tutto era molto pulito, accogliente e perfettamente attrezzato. In cucina non mancava nulla, câ€™era lâ€™aria condizionata per le giornate piÃ¹ calde, un letto comodo e anche un piccolo balcone con una bella vista. Giovanni Ã¨ stato un ottimo padrone di casa: molto cordiale, disponibile e ci Ã¨ venuto a prendere di persona. Grazie per lâ€™eccellente soggiorno, torneremo volentieri!â€", en:"â€œWe immediately felt very comfortable in the apartment: everything was very clean, cozy, and perfectly equipped. The kitchen had everything we needed, there was air conditioning for the hotter days, a comfortable bed, and even a small balcony with a nice view. Giovanni was an excellent host: very friendly, helpful, and he came to pick us up in person. Thank you for the wonderful stay â€” we will gladly come backâ€", es:"â€œNos sentimos inmediatamente muy a gusto en el apartamento: todo estaba muy limpio, acogedor y perfectamente equipado. En la cocina no faltaba nada, habÃ­a aire acondicionado para los dÃ­as mÃ¡s calurosos, una cama cÃ³moda y hasta un pequeÃ±o balcÃ³n con una bonita vista. Giovanni fue un excelente anfitriÃ³n: muy amable, atento y vino a recogernos personalmente. Gracias por la estancia maravillosa, Â¡volveremos con mucho gusto!â€" },
    "reviews.r4": { it:"â€œLâ€™appartamento si trova nel centro storico di Salerno, in una strada tranquilla a pochi passi da bar, ristoranti e supermercati. Come in molte zone della cittÃ , per raggiungerlo câ€™Ã¨ una salita piuttosto ripida. Gli spazi sono contenuti ma ben organizzati e arredati, con due balconi. Lâ€™host Ã¨ stato molto cordiale e comunicativo.â€", en:"â€œThe apartment is located in Salernoâ€™s historic center, on a quiet street just a short walk from bars, restaurants, and supermarkets. As in many parts of the city, thereâ€™s a fairly steep hill up to the apartment. The space is compact but well laid out and furnished, with two balconies. The host was very friendly and communicative.â€", es:"â€œEl apartamento se encuentra en el centro histÃ³rico de Salerno, en una calle tranquila y a pocos pasos de bares, restaurantes y supermercados. Como en muchas zonas de la ciudad, hay una cuesta bastante empinada para llegar al apartamento. El espacio es compacto pero bien distribuido y amueblado, con dos balcones. El anfitriÃ³n fue muy amable y comunicativo.â€" },
    "itin.titleNear": { it:"Itinerari vicini", en:"Nearby itineraries", es:"Itinerarios cercanos" },
    "itin.hint": { it:"Idee per mezza giornata o giornata intera. Tempi indicativi da Blu Mediterraneo.", en:"Ideas for a half or full day. Approximate times from Blu Mediterraneo.", es:"Ideas para medio dÃ­a o dÃ­a completo. Tiempos aproximados desde Blu Mediterraneo." },
    "itin.openmap": { it:"Apri mappa", en:"Open map", es:"Abrir mapa" },
    "itin.btn.dir": { it:"Indicazioni", en:"Directions", es:"Indicaciones" },
    "itin.btn.transit": { it:"Trasporti", en:"Transit", es:"Transporte" },
    "itin.btn.ferry": { it:"Traghetti", en:"Ferries", es:"Ferries" },
    "itin.seasonal": { it:"â›´ï¸ Servizio traghetti", en:"â›´ï¸ Ferries service", es:"â›´ï¸ servicio ferries" },
    "itin.ferryNote": { it:"Per traghetti e orari cliccare sul bottone â€œTraghettiâ€: si apre il sito di Travelmar.", en:"For ferries and timetables click the â€œFerriesâ€ button: it opens the Travelmar website.", es:"Para ferries y horarios, haz clic en â€œFerriesâ€: se abre la web de Travelmar." },
    "badge.coast": { it:"ğŸŒŠ Costiera", en:"ğŸŒŠ Coast", es:"ğŸŒŠ Costa" },
    "badge.village": { it:"ğŸ˜ï¸ Borgo", en:"ğŸ˜ï¸ Village", es:"ğŸ˜ï¸ Pueblo" },
    "badge.iconic": { it:"â­ Iconico", en:"â­ Iconic", es:"â­ IcÃ³nico" },
    "badge.views": { it:"ğŸ”ï¸ Panorami", en:"ğŸ”ï¸ Viewpoints", es:"ğŸ”ï¸ Miradores" },
    "badge.spots": { it:"ğŸ“· Scorci", en:"ğŸ“· Photo spots", es:"ğŸ“· Rincones" },
    "badge.unesco": { it:"ğŸ›ï¸ UNESCO", en:"ğŸ›ï¸ UNESCO", es:"ğŸ›ï¸ UNESCO" },
    "contact.title": { it:"Per contattarci...", en:"Contact us...", es:"Para contactarnos..." },
    "contact.name": { it:"Nome", en:"Name", es:"Nombre" },
    "contact.msg": { it:"Messaggio", en:"Message", es:"Mensaje" },
    "contact.send": { it:"Invia richiesta", en:"Send request", es:"Enviar solicitud" },
    "contact.orLead": { it:"Oppure scrivici su", en:"Or message us on", es:"O escrÃ­benos por" },
    "contact.orMid": { it:"o via email a", en:"or via email at", es:"o por correo a" },
    "contact.where": { it:"Dove siamo", en:"Where we are", es:"DÃ³nde estamos" },
    "contact.whereDesc": { it:"A pochi minuti dal mare, zona tranquilla e comoda ai servizi.", en:"Just a few minutes from the beach, in a quiet area close to amenities.", es:"A pocos minutos de la playa, en una zona tranquila y bien comunicada." },
    "contact.openGmaps": { it:"Apri su Google Maps", en:"Open in Google Maps", es:"Abrir en Google Maps" },
    "contact.openGmail": { it:"Apri in Gmail", en:"Open in Gmail", es:"Abrir en Gmail" },
    "contact.namePh": { it:"Il tuo nome", en:"Your name", es:"Tu nombre" },
    "contact.msgPh": { it:"Scrivi qui...", en:"Write here...", es:"Escribe aquÃ­..." },
    "contact.hi": { it:"Ciao,", en:"Hello,", es:"Hola," },
    "contact.thanks": { it:"Grazie!", en:"Thank you!", es:"Â¡Gracias!" },
    "contact.subjectBase":{ it:"Richiesta informazioni â€“ Blu Mediterraneo", en:"Info request â€“ Blu Mediterraneo", es:"Solicitud de informaciÃ³n â€“ Blu Mediterraneo" },
  "contact.testoMail":{ it:"Cliccando su <strong>Invia richiesta</strong> il tuo messaggio verrÃ  inviato via email a <i>blumediterraneo.seansleep@gmail.com</i>", en: "By clicking <strong>Send request</strong>, your message will be sent by email to <i>blumediterraneo.seansleep@gmail.com</i>", es:"Al hacer clic en <strong>Enviar solicitud</strong>, tu mensaje se enviarÃ¡ por correo electrÃ³nico a <i>blumediterraneo.seansleep@gmail.com.</i>"},
  "contact.testoWz":{ it:'Se preferisci, puoi contattarci anche su', en: "If you prefer, you can also contact us on", es:"Si lo prefieres, tambiÃ©n puedes contactarnos por"},
   "aria.openLang": { it:"Apri selettore lingua", en:"Open language selector", es:"Abrir selector de idioma" },
    "footer.airBnb": { it:"Per maggiori dettagli dell appartamento potete consultare airBnb", en:"For more details about the apartment you can check Airbnb", es:"Para mÃ¡s detalles del apartamento consulta Airbnb" }
  };

    /* ===== Util ===== */
    function fmtDateYYYYMMDD(){
      const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Rome' }));
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    const t = (key, lang = (window.CUR_LANG || document.documentElement.lang || 'it').toLowerCase()) =>
      (I18N?.[key]?.[lang] ?? I18N?.[key]?.it ?? key);

    /* ===== Email builder + provider detection + links ===== */
    function buildEmail(lang){
      const form = document.forms.contact;
      const name = form?.elements.name?.value.trim() || '';
      const from = form?.elements.email?.value.trim() || '';
      const msg = form?.elements.message?.value.trim() || '';
      const dateStr = fmtDateYYYYMMDD();
      const subject = `${t('contact.subjectBase', lang)}${name ? ` â€“ ${name}` : ''} â€“ ${dateStr}`;
      const body = `${t('contact.hi', lang)}\n\n${t('contact.msg', lang)}: ${msg || '___'}\n\n\n${t('contact.name', lang)}: ${name || '___'}\n\n\n${t('contact.thanks', lang)}`;
      const to = 'blumediterraneo.seansleep@gmail.com';
      const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const gmail = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const outlook = `https://outlook.live.com/owa/?path=/mail/action/compose&to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const yahoo = `https://compose.mail.yahoo.com/?to=${encodeURIComponent(to)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { mailto, gmail, outlook, yahoo, from };
    }
    function detectMailProvider(from){
      const e = (from || '').trim().toLowerCase();
      if (!e) return 'mailto';
      if (/@gmail\.com$/.test(e)) return 'gmail';
      if (/@(outlook|hotmail|live|msn)\.[a-z.]+$/.test(e)) return 'outlook';
      if (/@(yahoo|ymail|rocketmail)\.[a-z.]+$/i.test(e)) return 'yahoo';
      return 'mailto';
    }
    function updateMailLink(lang){
      const { mailto, gmail } = buildEmail(lang);
      const a = document.getElementById('mailLink');
      if (a) a.href = mailto;
      const g = document.getElementById('mailGmailLink');
      if (g) g.href = gmail;
    }

    /* ===== WhatsApp ===== */
    function updateWhatsAppLink(lang){
      const l = (lang || window.CUR_LANG || document.documentElement.lang || 'it').toLowerCase();
      const msgInfo = l === 'en' ? "Hello! I would like information about Blu Mediterraneo"
                     : l === 'es' ? "Â¡Hola! Me gustarÃ­a informaciÃ³n sobre Blu Mediterraneo"
                     : "Ciao! Vorrei informazioni su Blu Mediterraneo";
      const msgShuttle = l === 'en' ? "Hi! I'd like a shuttle/tour quote (Blu Mediterraneo). Date __, time __, route __, passengers __."
                       : l === 'es' ? "Â¡Hola! Quisiera un presupuesto de traslado/tour (Blu Mediterraneo). Fecha __, hora __, ruta __, pasajeros __."
                       : "Ciao! Vorrei un preventivo navetta/tour (Blu Mediterraneo). Data __, orario __, tratta __, persone __.";
      const hrefInfo = "https://wa.me/393331082912?text=" + encodeURIComponent(msgInfo);
      const hrefShuttle = "https://wa.me/393331082912?text=" + encodeURIComponent(msgShuttle);
      const fab = document.getElementById('waFab');
      const wa = document.getElementById('waLink');
      if (fab) fab.href = hrefInfo;
      if (wa) wa.href = hrefInfo;
      const btn = document.getElementById('shuttleWaTop2');
      const btn2 = document.getElementById('shuttleWaTop');
      if (btn) btn.href = hrefShuttle;
      if (btn2) btn2.href = hrefShuttle;
    }

    /* ===== Galleria ===== */
    const GALLERY_TABS = [
      { id:"giorno",  i18n:"gallery.tab.day",     folder:"images/zona_pranzo",  total:12, captionBase:{it:"Zona giorno", en:"Living area", es:"Zona de dÃ­a"} },
      { id:"notte",   i18n:"gallery.tab.night",   folder:"images/camera_letto", total:7,  captionBase:{it:"Zona notte",  en:"Bedroom",     es:"Dormitorio"} },
      { id:"bagno",   i18n:"gallery.tab.bath",    folder:"images/bagno",        total:4,  captionBase:{it:"Bagno",       en:"Bathroom",    es:"BaÃ±o"} },
      { id:"balcone", i18n:"gallery.tab.balcony", folder:"images/esterni",      total:11, captionBase:{it:"Balcone / Esterni", en:"Balcony / Outside", es:"BalcÃ³n / Exteriores"} },
    ];
    const imagesFrom = (folder,n)=> Array.from({length:n}, (_,i)=>`${folder}/${i+1}.jpg`);

    function renderGalTabs(activeId){
      const tabsEl = document.getElementById('galTabs');
      const lang = window.CUR_LANG || 'it';
      if (!tabsEl) return activeId;
      tabsEl.innerHTML = '';
      GALLERY_TABS.forEach((tab)=>{
        const btn = document.createElement('button');
        btn.className='gal-tab';
        btn.role='tab';
        btn.setAttribute('aria-selected', tab.id===activeId ? 'true':'false');
        btn.setAttribute('aria-controls','galGrid');
        const label = I18N[tab.i18n]?.[lang] || tab.id;
        btn.innerHTML = `${label} <span class="gal-count">(${tab.total})</span>`;
        btn.addEventListener('click', ()=> setActiveTab(tab.id));
        btn.addEventListener('keydown', e=>{
          if(e.key==='Enter'||e.key===' '){e.preventDefault(); setActiveTab(tab.id);}
        });
        tabsEl.appendChild(btn);
      });
      return activeId;
    }

    /* Lightbox stato + azioni */
    const LB = { list:[], base:"", index:0, open:false };
    function openLightboxAt(index){
      LB.index = index; LB.open = true;
      const img = document.getElementById('lightImg');
      const cap = document.getElementById('lightCap');
      if (img) img.src = LB.list[index];
      if (img) img.alt = `${LB.base} ${index+1}`;
      if (cap) cap.textContent = `${LB.base} ${index+1} / ${LB.list.length}`;
      const lb = document.getElementById('lightbox');
      if (lb){ lb.setAttribute('open',''); lb.removeAttribute('aria-hidden'); }
      document.addEventListener('keydown', onLbKey);
    }
    function closeLightbox(){
      const lb = document.getElementById('lightbox');
      if (lb){ lb.removeAttribute('open'); lb.setAttribute('aria-hidden','true'); }
      const img = document.getElementById('lightImg'); if (img) img.src = '';
      LB.open = false; document.removeEventListener('keydown', onLbKey);
    }
    function onLbKey(e){
      if(!LB.open) return;
      if(e.key === 'Escape') closeLightbox();
      if(e.key === 'ArrowRight') showNext();
      if(e.key === 'ArrowLeft') showPrev();
    }
    function showAt(idx){
      if(!LB.list.length) return;
      LB.index = (idx + LB.list.length) % LB.list.length;
      const img = document.getElementById('lightImg');
      const cap = document.getElementById('lightCap');
      if (img){ img.src = LB.list[LB.index]; img.alt = `${LB.base} ${LB.index+1}`; }
      if (cap) cap.textContent = `${LB.base} ${LB.index+1} / ${LB.list.length}`;
    }
    const showNext = ()=> showAt(LB.index+1);
    const showPrev = ()=> showAt(LB.index-1);

    function renderGalGrid(tabId){
      const grid = document.getElementById('galGrid');
      const lang = window.CUR_LANG || 'it';
      const tab = GALLERY_TABS.find(x=>x.id===tabId) || GALLERY_TABS[0];
      const imgs = imagesFrom(tab.folder, tab.total);
      const base = tab.captionBase[lang] || tab.captionBase.it;
      if (grid){
        grid.innerHTML = imgs.map((src,i)=> `
          <figure class="photo">
            <img src="${src}" alt="${base}" loading="lazy" data-idx="${i}">
            <figcaption>${base}</figcaption>
          </figure>
        `).join('');
        LB.list = imgs; LB.base = base; LB.index = 0;
        grid.querySelectorAll('img').forEach(img=>{
          img.addEventListener('click', ()=>{
            const i = Number(img.getAttribute('data-idx'))||0;
            openLightboxAt(i);
          });
        });
      }
    }

    (function initLightboxControls(){
      const lb = document.getElementById('lightbox'); if (!lb) return;
      document.getElementById('lbPrev')?.addEventListener('click', showPrev);
      document.getElementById('lbNext')?.addEventListener('click', showNext);
      document.getElementById('lbClose')?.addEventListener('click', closeLightbox);
      lb.addEventListener('click', (e)=>{ if(e.target.id==='lightbox') closeLightbox(); });
      let sx=null;
      lb.addEventListener('touchstart', e=>{ sx = e.touches[0].clientX; }, {passive:true});
      lb.addEventListener('touchend', e=>{
        if(sx==null) return;
        const dx = e.changedTouches[0].clientX - sx;
        if(Math.abs(dx) > 50){ if(dx<0) showNext(); else showPrev(); }
        sx=null;
      }, {passive:true});
    })();

    function setActiveTab(id){ window.LAST_TAB_ID = id; renderGalTabs(id); renderGalGrid(id); }
    (function initGalleryTabs(){
      const urlAlbum = new URL(location.href).searchParams.get('album');
      const startId = urlAlbum || 'balcone';
      renderGalTabs(startId); renderGalGrid(startId); window.LAST_TAB_ID = startId;
    })();

    /* ===== Lingua ===== */
    function applyContactLang(lang){
      document.querySelectorAll('#contatti [data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n'); const val = t(key, lang);
        (/<\/?[a-z][\s\S]*>/i.test(val)) ? (el.innerHTML = val) : (el.textContent = val);
      });
      document.querySelectorAll('#contatti [data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder'); const val = t(key, lang);
        if (val != null) el.setAttribute('placeholder', val);
      });
      updateMailLink(lang); updateWhatsAppLink(lang);
    }
    function setLang(lang){
      window.CUR_LANG = lang;
      document.documentElement.setAttribute('lang', lang);
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n'); const val = I18N[key]?.[lang];
        if (val != null) { (/<\/?[a-z][\s\S]*>/i.test(val)) ? el.innerHTML = val : el.textContent = val; }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder'); const val = I18N[key]?.[lang];
        if (val != null) el.setAttribute('placeholder', val);
      });
      const langCurrent = document.getElementById('langCurrent');
      if (langCurrent) langCurrent.textContent = lang.toUpperCase();
      document.querySelectorAll('#langMenu [data-lang]').forEach(a=>{
        const is = a.getAttribute('data-lang') === lang;
        a.parentElement?.setAttribute('aria-selected', is ? 'true':'false');
      });
      applyContactLang(lang);
      try {
        localStorage.setItem('lang', lang);
        const url = new URL(location.href); url.searchParams.set('lang', lang);
        history.replaceState({}, '', url);
      } catch(e){}
      const activeId = window.LAST_TAB_ID || 'balcone';
      setActiveTab(activeId);
    }

    /* ==== Sync altezza header -> var CSS --nav-h ==== */
    function syncNavHeight(){
      const h = document.querySelector('header')?.offsetHeight || 64;
      document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    window.addEventListener('load', syncNavHeight);
    window.addEventListener('resize', syncNavHeight);

    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    /* ---- Menu mobile migliorato ---- */
    const menuBtn = document.getElementById('menuBtn');
    const navLinks = document.getElementById('navLinks');
    const navOv = document.getElementById('navOverlay');
    const navCloseTop = document.getElementById('navCloseTop');

    function setMenu(open){
      navLinks?.setAttribute('data-open', String(open));
      menuBtn?.setAttribute('aria-expanded', String(open));
      if (open) document.documentElement.setAttribute('data-menu-open','true');
      else document.documentElement.removeAttribute('data-menu-open');

      if (navOv){
        if (open){
          navOv.hidden = false;
          requestAnimationFrame(()=> navOv.setAttribute('data-open','true'));
          document.documentElement.style.overflow = 'hidden';
        } else {
          navOv.removeAttribute('data-open');
          document.documentElement.style.overflow = '';
          setTimeout(()=>{ navOv.hidden = true; }, 150);
        }
      }
      // ricalcola (header puÃ² cambiare altezza)
      setTimeout(syncNavHeight, 0);
    }

    menuBtn?.addEventListener('click', ()=>{
      const isOpen = navLinks?.getAttribute('data-open')==='true';
      setMenu(!isOpen);
    });
    navCloseTop?.addEventListener('click', ()=> setMenu(false));
    navOv?.addEventListener('click', ()=> setMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') setMenu(false); });
    navLinks?.querySelectorAll('a').forEach(a=> a.addEventListener('click', ()=> setMenu(false)));
    window.addEventListener('resize', ()=>{ if (window.innerWidth > 960) setMenu(false); });

    /* ---- Lingua dropdown ---- */
    const langBtn = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    function closeLang(){ if (!langBtn || !langMenu) return; langBtn.setAttribute('aria-expanded','false'); langMenu.hidden = true; }
    function openLang(){ if (!langBtn || !langMenu) return; langBtn.setAttribute('aria-expanded','true'); langMenu.hidden = false; }
    if (langBtn && langMenu){
      langBtn.addEventListener('click', ()=> (langBtn.getAttribute('aria-expanded')==='true') ? closeLang() : openLang());
      document.addEventListener('click', (e)=>{ if(!e.target.closest?.('.lang')) closeLang(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLang(); });
      document.querySelectorAll('#langMenu [data-lang]').forEach(a=>{
        a.addEventListener('click', (e)=>{ e.preventDefault(); setLang(a.getAttribute('data-lang')); closeLang(); });
      });
    }

    /* ===== Init lingua ===== */
    (function initLang(){
      const urlLang = new URL(location.href).searchParams.get('lang');
      let saved = 'it';
      try { saved = localStorage.getItem('lang') || 'it'; } catch(e){}
      const lang = (urlLang || saved || 'it').toLowerCase();
      setLang(lang);
    })();

    /* ===== Submit form con provider detection + fallback ===== */
    (function wireContactSubmit(){
      const form = document.forms.contact; if (!form) return;
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const lang = window.CUR_LANG || document.documentElement.lang || 'it';
        const { mailto, gmail, outlook, yahoo, from } = buildEmail(lang);
        const prov = detectMailProvider(from);
        const url = prov === 'gmail' ? gmail : prov === 'outlook' ? outlook : prov === 'yahoo' ? yahoo : mailto;
        const win = window.open(url, '_blank');
        if (!win || win.closed || typeof win.closed === 'undefined') { location.href = mailto; }
      });
    })();

    (function liveMailUpdates(){
      const form = document.forms.contact; if (!form) return;
      ['name','email','message'].forEach(n => {
        const el = form.elements[n];
        if (el) el.addEventListener('input', () => updateMailLink(window.CUR_LANG || 'it'));
      });
    })();

    /* ===== Reviews carousel ===== */
    (function(){
      const scroller = document.getElementById('reviews');
      const next = document.getElementById('revNext');
      const prev = document.getElementById('revPrev');
      if (!scroller || !next || !prev) return;
      function scrollByStep(dir=1){ const step = Math.round(scroller.clientWidth * 0.8); scroller.scrollBy({left: step*dir, behavior:'smooth'}); }
      next.addEventListener('click', ()=>scrollByStep(1));
      prev.addEventListener('click', ()=>scrollByStep(-1));
      let isDown=false, startX=0, scrollStart=0;
      const start = (x)=>{ isDown=true; startX=x; scrollStart=scroller.scrollLeft; };
      const move = (x)=>{ if(!isDown) return; scroller.scrollLeft = scrollStart - (x-startX); };
      const end = ()=>{ isDown=false; };
      scroller.addEventListener('mousedown', e=>start(e.pageX));
      window.addEventListener('mousemove', e=>move(e.pageX));
      window.addEventListener('mouseup', end);
      scroller.addEventListener('touchstart', e=>start(e.touches[0].pageX), {passive:true});
      window.addEventListener('touchmove', e=>move(e.touches[0].pageX), {passive:true});
      window.addEventListener('touchend', end);
    })();
 